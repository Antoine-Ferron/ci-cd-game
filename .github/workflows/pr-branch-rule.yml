name: PR Branch Rules

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

jobs:
  check-branch-rules:
    runs-on: ubuntu-latest
    steps:
      - name: Check source and target branches
        id: check
        run: |
          echo "Source: ${{ github.head_ref }}"
          echo "Target: ${{ github.base_ref }}"
          SOURCE="${{ github.head_ref }}"
          TARGET="${{ github.base_ref }}"

          if [[ "$TARGET" =~ ^release/ ]]; then
            if [[ ! "$SOURCE" =~ ^(main|bug/) ]]; then
              echo "‚ùå Invalid PR: Only 'main' or 'bug/*' can target 'release/*' branches."
              exit 1
            fi
          fi

      - name: Close invalid PR automatically
        if: failure()
        uses: peter-evans/close-pull-request@v3
        with:
          comment: |
            üö´ Cette PR a √©t√© ferm√©e automatiquement :
            - Les branches `release/x` ne peuvent √™tre aliment√©es que depuis `main` ou `bug/x`.
            Merci de corriger la source avant de rouvrir.
